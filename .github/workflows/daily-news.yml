name: Daily News & Portfolio Automation

on:
  schedule:
    # Run every day at 7:00 AM Singapore Time (SGT = UTC+8, so 23:00 UTC previous day)
    - cron: '0 23 * * *'
  workflow_dispatch: # Allow manual trigger
    inputs:
      test_run:
        description: 'Run as test (no email)'
        required: false
        default: 'false'
        type: boolean
      newsletter_type:
        description: 'Which newsletter to run'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - daily-only
          - portfolio-only

jobs:
  fetch-and-send-newsletters:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Newsletter Automation
      env:
        EMAIL_SERVICE: gmail
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        # OAuth2 Credentials (Modern Security - Recommended)
        GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
        GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
        GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
        # Fallback: Basic Auth
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        TEST_RUN: ${{ github.event.inputs.test_run || 'false' }}
        SEND_EMAILS: 'true'
      run: |
        NEWSLETTER_TYPE="${{ github.event.inputs.newsletter_type || 'both' }}"
        echo "Starting Newsletter Automation (Type: $NEWSLETTER_TYPE)..."
        
        if [ "$TEST_RUN" = "true" ]; then
          echo "Running in test mode - no emails will be sent"
        fi
        
        case "$NEWSLETTER_TYPE" in
          "daily-only")
            echo "ðŸ“ˆ Running Daily Market Briefing only..."
            npm run daily-news
            ;;
          "portfolio-only")
            echo "ðŸ“Š Running Portfolio News only..."
            npm run portfolio-news
            ;;
          "both"|*)
            echo "ðŸ“ˆðŸ“Š Running both Daily Market Briefing and Portfolio News..."
            npm run all-news
            ;;
        esac
        
    - name: Upload report artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: newsletter-reports-${{ github.run_number }}
        path: reports/
        retention-days: 30
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "Newsletter Automation failed at $(date)"
        echo "Check the logs for more details"
        exit 1